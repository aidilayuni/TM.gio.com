<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KPI Input — Kedah & Perlis</title>
<style>
  :root{
    --bg:#d47c08;
    --panel:linear-gradient(180deg,#0d0b12,#0a0810);
    --accent:#ff9b2e;
    --muted:#eeeef0;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    color:#fff;
    background:linear-gradient(180deg,var(--bg),#0b0710 60%);
    min-height:100vh;
    padding:28px;
  }
  .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:20px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,155,46,0.04)}
  h1{font-family: "Orbitron",sans-serif;color:#fff;margin:0 0 8px;font-size:1.2rem}
  p.lead{color:var(--muted);margin:6px 0 18px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th, td{padding:8px;border-bottom:1px solid rgba(255,155,46,0.06);text-align:left;color:var(--muted);font-weight:600}
  input[type="number"]{width:80px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .zone-title{font-weight:800;color:#ffd7ab;margin-bottom:6px}
  .actions{display:flex;gap:8px;margin-top:12px}
  button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn-save{background:linear-gradient(90deg,var(--accent),#ff6b00);color:#111}
  .btn-clear{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .side{position:sticky;top:28px;height:fit-content}
  textarea{width:100%;height:120px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:8px}
  .note{font-size:12px;color:#ffd7ab;margin-top:10px}
  .preview-table{width:100%;border-collapse:collapse;margin-top:10px}
  .preview-table th, .preview-table td{padding:6px;border:1px solid rgba(255,155,46,0.06);font-size:13px;color:var(--muted)}
  .success{color:#b3ffb3;margin-top:8px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Enter KPI Percentages — KEDAH & PERLIS</h1>
      <p class="lead">Fill percentage values (0 - 100) for each KPI per zone. Values are stored locally (browser localStorage) and will appear on the KPI dashboard.</p>

      <form id="kpiForm">
        <input type="hidden" id="state" value="KEDAH&PERLIS">

        <!-- Zones and KPIs -->
        <div id="zonesContainer"></div>

        <div class="actions">
          <button type="button" class="btn-save" id="saveBtn">Save KPI</button>
          <button type="button" class="btn-clear" id="clearBtn">Clear Saved</button>
        </div>

        <div id="msg" class="success" aria-live="polite"></div>
      </form>

      <p class="note">KPIs: MCATi, MCATi NO SHOW, NPSA, NPSF, MCATr, MCATr NO SHOW, CTIR.</p>
    </div>

    <div class="card side">
      <h1>Current / Import-Export</h1>
      <p class="lead">Preview current saved KPI JSON or paste JSON to import.</p>

      <div>
        <strong>Current saved JSON</strong>
        <textarea id="savedJson" readonly></textarea>
        <button class="btn-clear" id="copyJson">Copy JSON</button>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,155,46,0.06)">

      <div>
        <strong>Import JSON</strong>
        <textarea id="importJson" placeholder='Paste JSON here then click "Import JSON"'></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="importBtn" class="btn-save">Import JSON</button>
          <button id="resetPreview" class="btn-clear">Reload Preview</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,155,46,0.06)">

      <div>
        <strong>Live preview</strong>
        <table class="preview-table" id="previewTable">
          <thead>
            <tr><th>Zone</th><th>MCATi</th><th>MCATi NO SHOW</th><th>NPSA</th><th>NPSF</th><th>MCATr</th><th>MCATr NO SHOW</th><th>CTIR</th></tr>
          </thead>
          <tbody id="previewBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // Zones and KPI keys
  const ZONES = ['ALOR SETAR','JITRA','KULIM','LANGKAWI','PERLIS','SG PETANI'];
  const KPI_KEYS = ['MCATi','MCATi_NO_SHOW','NPSA','NPSF','MCATr','MCATr_NO_SHOW','CTIR'];
  const STORAGE_KEY = 'kpi_kedah_perlis_v1';

  // Build input rows
  const zonesContainer = document.getElementById('zonesContainer');
  ZONES.forEach(zone => {
    const wrapper = document.createElement('div');
    wrapper.className = 'card';
    wrapper.style.marginBottom = '12px';
    wrapper.innerHTML = `<div class="zone-title">${zone}</div>`;
    const row = document.createElement('div');
    row.className = 'row';
    KPI_KEYS.forEach(k => {
      const label = k.replace(/_/g,' ');
      const control = document.createElement('div');
      control.style.display = 'flex';
      control.style.flexDirection = 'column';
      control.style.gap = '6px';
      control.innerHTML = `<label style="font-size:12px;color:var(--muted)">${label}</label>
        <input type="number" min="0" max="100" step="0.01" data-zone="${zone}" data-key="${k}" placeholder="%">`;
      row.appendChild(control);
    });
    wrapper.appendChild(row);
    zonesContainer.appendChild(wrapper);
  });

  // Helpers
  function readInputs() {
    const inputs = document.querySelectorAll('#zonesContainer input[type=number]');
    const obj = { state: document.getElementById('state').value, zones: {} };
    inputs.forEach(inp => {
      const zone = inp.dataset.zone;
      const key = inp.dataset.key;
      if (!obj.zones[zone]) obj.zones[zone] = {};
      const v = inp.value.trim();
      obj.zones[zone][key] = v === '' ? null : Number(v);
    });
    return obj;
  }

  function populateFormFrom(obj) {
    if(!obj || !obj.zones) return;
    document.querySelectorAll('#zonesContainer input[type=number]').forEach(inp => {
      const zone = inp.dataset.zone;
      const key = inp.dataset.key;
      if(obj.zones[zone] && obj.zones[zone][key] !== undefined && obj.zones[zone][key] !== null){
        inp.value = obj.zones[zone][key];
      } else {
        inp.value = '';
      }
    });
    renderPreview(obj);
  }

  function renderPreview(obj) {
    const tbody = document.getElementById('previewBody');
    tbody.innerHTML = '';
    ZONES.forEach(zone => {
      const tr = document.createElement('tr');
      const zoneCell = document.createElement('td');
      zoneCell.textContent = zone;
      tr.appendChild(zoneCell);
      KPI_KEYS.forEach(k => {
        const td = document.createElement('td');
        const v = obj && obj.zones && obj.zones[zone] && obj.zones[zone][k];
        td.textContent = (v === null || v === undefined) ? '-' : (Number.isFinite(v) ? v : '-');
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    document.getElementById('savedJson').value = JSON.stringify(obj, null, 2);
  }

  // Save/load functions
  function saveToStorage(obj) {
    // Basic validation: all numbers between 0-100 or null
    for(const zone of ZONES){
      for(const k of KPI_KEYS){
        const v = obj.zones[zone][k];
        if (v !== null && v !== undefined) {
          if (isNaN(v) || v < 0 || v > 100){
            return { ok:false, message: `Invalid value for ${zone} - ${k}. Use 0 to 100.` };
          }
        }
      }
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    return { ok:true };
  }

  function loadFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch(e){
      console.error(e);
      return null;
    }
  }

  // Events
  document.getElementById('saveBtn').addEventListener('click', () => {
    const obj = readInputs();
    const res = saveToStorage(obj);
    const msg = document.getElementById('msg');
    if(!res.ok){ msg.textContent = res.message; msg.style.color = '#ffb3b3'; return; }
    msg.textContent = 'Saved successfully.';
    msg.style.color = '#b3ffb3';
    document.getElementById('savedJson').value = JSON.stringify(obj, null, 2);
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    if (!confirm('Clear saved KPI data?')) return;
    localStorage.removeItem(STORAGE_KEY);
    document.getElementById('msg').textContent = 'Saved data cleared.';
    document.getElementById('savedJson').value = '';
    populateFormFrom({ state: 'KEDAH&PERLIS', zones: {} });
  });

  // copy json button
  document.getElementById('copyJson').addEventListener('click', () => {
    const txt = document.getElementById('savedJson').value;
    if(!txt) return alert('No saved JSON');
    navigator.clipboard?.writeText(txt).then(()=> alert('Copied!'), ()=> alert('Copy failed'));
  });

  // import json
  document.getElementById('importBtn').addEventListener('click', () => {
    const raw = document.getElementById('importJson').value.trim();
    if(!raw) return alert('Paste JSON to import');
    try {
      const obj = JSON.parse(raw);
      // minimal shape check
      if(!obj.zones) throw new Error('Invalid structure: missing zones');
      // set into localStorage
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      populateFormFrom(obj);
      document.getElementById('msg').textContent = 'Imported successfully.';
    } catch(e){
      alert('Invalid JSON: ' + e.message);
    }
  });

  document.getElementById('resetPreview').addEventListener('click', () => {
    const cur = loadFromStorage();
    if(cur) populateFormFrom(cur);
    else populateFormFrom({ state: 'KEDAH&PERLIS', zones: {} });
  });

  // init: load saved
  (function init(){
    const cur = loadFromStorage();
    if (cur) populateFormFrom(cur);
    else {
      // initialize empty structure so preview shows dashes
      const empty = { state: 'KEDAH&PERLIS', zones: {} };
      ZONES.forEach(z => { empty.zones[z] = {}; KPI_KEYS.forEach(k=> empty.zones[z][k] = null); });
      populateFormFrom(empty);
    }
  })();
</script>
</body>
</html>
