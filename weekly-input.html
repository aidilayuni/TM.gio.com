<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Weekly KPI Input — Kedah & Perlis</title>
<style>
  :root{
    --bg:#d47c08;
    --muted:#eeeef0;
    --accent:#ff9b2e;
    --card:#0b0710;
    --zone-col:#f2efe9;
    --zone-text:#1a1a1a;
    --input-bg:rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#fff;background:linear-gradient(180deg,var(--bg),#0b0710 60%);padding:20px}
  .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:linear-gradient(180deg,rgba(0,0,0,0.55),rgba(0,0,0,0.45));padding:18px;border-radius:12px;border:1px solid rgba(255,155,46,0.04)}
  h1{margin:0 0 8px;font-family:Orbitron,sans-serif;color:#f58003}
  p.lead{color:var(--muted);margin:6px 0 16px}
  .kpi-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .kpi-tab{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:800;color:var(--muted);font-size:13px}
  .kpi-tab.active{background:linear-gradient(90deg,var(--accent),#ff6b00);color:#111;border-color:transparent}
  /* big KPI header */
  .kpi-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .kpi-label{background:linear-gradient(180deg,#0f1724,#0b1220);padding:12px 16px;border-radius:8px;color:#ffd7ab;font-weight:900;min-width:220px;text-transform:uppercase;letter-spacing:1px}
  .kpi-sub{color:var(--muted);font-weight:700}

  /* state input at top */
  .state-input-wrap{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .state-input-wrap label{font-weight:800;color:#ffd7ab}
  .state-input{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:#fff;font-weight:800}

  /* zone table - matches screenshot style */
  .zone-table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:8px}
  .zone-table thead th{background:#07202a;color:#fff;padding:10px;text-align:left;font-weight:800;border-bottom:1px solid rgba(255,255,255,0.04)}
  .zone-table tbody tr{background:transparent}
  .zone-col{background:linear-gradient(180deg,#e9f1f4,#f8fbfc);color:var(--zone-text);font-weight:800;padding:12px 14px;width:60%;vertical-align:middle}
  .zone-col small{display:block;color:#6b6b6b;font-weight:700;font-size:12px}
  .input-col{padding:10px 14px;text-align:center}
  input[type=number].zone-input{
    width:140px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:var(--input-bg);color:#fff;font-weight:800;
  }

  /* actions & import/export */
  .actions{display:flex;gap:8px;margin-top:14px}
  button{padding:10px 14px;border-radius:8px;border:none;font-weight:800;cursor:pointer}
  .btn-save{background:linear-gradient(90deg,var(--accent),#ff6b00);color:#111}
  .btn-clear{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .btn-back{background:transparent;border:1px solid rgba(255,155,46,0.45);color:#ffd7ab;padding:10px 14px;border-radius:8px;font-weight:800;cursor:pointer}
  textarea{width:100%;height:120px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:8px}
  .note{font-size:13px;color:#ffd7ab;margin-top:10px}
  .msg{margin-top:10px;font-weight:800}
  .ok{color:#b3ffb3}
  .err{color:#f3f0f0}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr} input[type=number].zone-input{width:100%} .kpi-label{min-width:140px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Weekly KPI Input — KEDAH & PERLIS</h1>
      <p class="lead">Select a KPI then enter weekly percentage values — both for the whole state and for each zone.</p>

      <!-- VISIBLE state name input -->
      <div class="state-input-wrap">
        <label for="state">State</label>
        <input id="state" class="state-input" type="text" value="KEDAH & PERLIS" />

      </div>

      <!-- KPI selector -->
      <div class="kpi-tabs" id="kpiTabs"></div>

      <div class="kpi-header">
        <div class="kpi-label" id="kpiLabel">MCATi</div>
        <div class="kpi-sub" id="kpiSub">Enter values beside each zone — use the top row for the whole state.</div>
      </div>

      <!-- zone table (top row reserved for state percentage) -->
      <table class="zone-table" id="zoneTable">
        <thead>
          <tr>
            <th style="width:70%">Zone / State</th>
            <th style="width:30%;text-align:center">Value (%)</th>
          </tr>
        </thead>
        <tbody id="zoneBody"></tbody>
      </table>

      <div class="actions" style="margin-top:12px">
        <button id="backBtn" class="btn-back" type="button">← Back to Dashboard</button>
        <button id="saveBtn" class="btn-save" type="button">Save Weekly</button>
        <button id="clearBtn" class="btn-clear" type="button">Clear Saved</button>
      </div>

      <div id="msg" class="msg ok" style="display:none"></div>
      <div class="note">Saved dataset key: <strong>weekly_kedah_perlis_v1</strong></div>
    </div>

    <div class="card">
      <h1>Import / Export</h1>
      <p class="lead">Preview or paste JSON to import.</p>

      <div>
        <strong>Saved JSON</strong>
        <textarea id="savedJson" readonly></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="copyJson" class="btn-clear">Copy JSON</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,155,46,0.04)">

      <div>
        <strong>Import JSON</strong>
        <textarea id="importJson" placeholder='Paste JSON here to import'></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="importBtn" class="btn-save">Import JSON</button>
          <button id="reloadPreview" class="btn-clear">Reload Preview</button>
        </div>
      </div>

      <div class="preview" style="margin-top:12px">
        <strong>Preview</strong>
        <table id="previewTable" style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th style="text-align:left;padding:8px">Zone</th><th style="text-align:center;padding:8px">Value</th></tr></thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const API_BASE = 'http://localhost:3000'; // change if needed
  const API_SAVE = `${API_BASE}/api/weekly/save`;
  const STORAGE_KEY = 'weekly_kedah_perlis_v1';
  // ==================

  const ZONES = ['ALOR SETAR','JITRA','KULIM','LANGKAWI','PERLIS','SG PETANI'];
  const KPI_KEYS = ['MCATi','MCATi_NO_SHOW','ISR','SRF_30DAYS','MCATr_NO_SHOW','MCATr','FFRU90',
    'SFRU','SRU24','NPSA','NPSF','SDZ_PRODUCTIVITY','CANCEL_CTT'];

  // data shape:
  // {
  //   state: 'KEDAH & PERLIS',
  //   stateTotals: { MCATi: 12, ISR: null, ... },
  //   zones: { 'ALOR SETAR': {MCATi: 12, ...}, ... }
  // }
  let DATA = { state:'KEDAH & PERLIS', stateTotals: {}, zones: {} };

  function enableEnterNavigation() {
  const inputs = Array.from(document.querySelectorAll('.zone-input'));

  inputs.forEach((inp, i) => {
    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();

        const next = inputs[i + 1];
        if (next) next.focus();
      }
    });
  });
}

  function emptyData(){
    const d = { state: document.getElementById('state')?.value || 'KEDAH & PERLIS', stateTotals: {}, zones:{} };
    ZONES.forEach(z => {
      d.zones[z] = {};
      KPI_KEYS.forEach(k => d.zones[z][k] = null);
    });
    KPI_KEYS.forEach(k => d.stateTotals[k] = null);
    return d;
  }

  // build KPI tabs
  const tabsEl = document.getElementById('kpiTabs');
  KPI_KEYS.forEach((k, idx) => {
    const btn = document.createElement('button');
    btn.type='button'; btn.className='kpi-tab'; btn.textContent = k;
    btn.dataset.kpi = k;
    if(idx===0) btn.classList.add('active');
    btn.addEventListener('click', ()=> { selectKPI(k); document.querySelectorAll('.kpi-tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); });
    tabsEl.appendChild(btn);
  });

  let currentKPI = KPI_KEYS[0];
  const zoneBody = document.getElementById('zoneBody');

  // render zone table — top row for state total, then zones
  function renderZoneTable(){
    document.getElementById('kpiLabel').textContent = currentKPI;
    zoneBody.innerHTML = '';

    // STATE ROW
    const stateName = document.getElementById('state').value || DATA.state || 'STATE';
    const trState = document.createElement('tr');
    const tdState = document.createElement('td'); tdState.className='zone-col';
    tdState.innerHTML = `<div style="font-weight:900">${stateName} (State)</div><small>State total for ${currentKPI}</small>`;
    trState.appendChild(tdState);

    const tdStateInput = document.createElement('td'); tdStateInput.className='input-col';
    const stateInp = document.createElement('input');
    stateInp.type='number'; stateInp.step='0.01'; stateInp.min='0'; stateInp.max='100';
    stateInp.className='zone-input';
    stateInp.dataset.zone = '__STATE__'; stateInp.dataset.kpi = currentKPI;
    const stateVal = DATA.stateTotals && DATA.stateTotals[currentKPI] !== undefined ? DATA.stateTotals[currentKPI] : null;
    if(stateVal !== null && stateVal !== undefined) stateInp.value = stateVal;
    stateInp.addEventListener('input', ()=> {
      const v = stateInp.value.trim();
      if(!DATA.stateTotals) DATA.stateTotals = {};
      DATA.stateTotals[currentKPI] = v === '' ? null : Number(v);
      updatePreview();
    });
    tdStateInput.appendChild(stateInp);
    trState.appendChild(tdStateInput);
    zoneBody.appendChild(trState);

    // ZONE ROWS
    ZONES.forEach(z => {
      const tr = document.createElement('tr');
      const tdZone = document.createElement('td'); tdZone.className='zone-col';
      tdZone.innerHTML = `<div>${z}</div><small>${stateName}</small>`;
      tr.appendChild(tdZone);

      const tdInput = document.createElement('td'); tdInput.className='input-col';
      const inp = document.createElement('input');
      inp.type='number'; inp.step='0.01'; inp.min='0'; inp.max='100';
      inp.className='zone-input';
      inp.dataset.zone = z; inp.dataset.kpi = currentKPI;
      const val = DATA.zones[z] && DATA.zones[z][currentKPI];
      if(val !== undefined && val !== null) inp.value = val;
      inp.addEventListener('input', ()=> {
        const zName = inp.dataset.zone, k = inp.dataset.kpi;
        const v = inp.value.trim();
        DATA.zones[zName][k] = v === '' ? null : Number(v);
        updatePreview();
      });
      tdInput.appendChild(inp);
      tr.appendChild(tdInput);
      zoneBody.appendChild(tr);
      enableEnterNavigation();
    });
  }

  function selectKPI(k){ currentKPI = k; renderZoneTable(); renderPreview(); }

  function updatePreview(){
    document.getElementById('savedJson').value = JSON.stringify(DATA, null, 2);
    renderPreview();
  }

  function renderPreview(){
    const pBody = document.getElementById('previewBody'); if(!pBody) return;
    pBody.innerHTML = '';
    // preview lists state then zones for current KPI
    const sTr = document.createElement('tr');
    const sTd1 = document.createElement('td'); sTd1.style.padding='8px'; sTd1.textContent = document.getElementById('state').value || DATA.state;
    const sTd2 = document.createElement('td'); sTd2.style.padding='8px'; sTd2.style.textAlign='center';
    const sv = DATA.stateTotals && DATA.stateTotals[currentKPI];
    sTd2.textContent = (sv === null || sv === undefined) ? '-' : (Number.isFinite(sv) ? sv + '%' : '-');
    sTr.appendChild(sTd1); sTr.appendChild(sTd2); pBody.appendChild(sTr);

    ZONES.forEach(z => {
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.style.padding='8px'; td1.textContent = z;
      const td2 = document.createElement('td'); td2.style.padding='8px'; td2.style.textAlign='center';
      const v = DATA.zones[z] && DATA.zones[z][currentKPI];
      td2.textContent = (v === null || v === undefined) ? '-' : (Number.isFinite(v) ? v + '%' : '-');
      tr.appendChild(td1); tr.appendChild(td2); pBody.appendChild(tr);
    });
  }

  // ===== persistence & server =====
  function saveToServer(datasetKey, obj){
    // include stateTotals in the payload
    return fetch(API_SAVE, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ dataset: datasetKey, state: obj.state, zones: obj.zones, stateTotals: obj.stateTotals || {} })
    }).then(async resp => {
      const ctype = resp.headers.get('content-type') || '';
      if (ctype.includes('application/json')) return { ok: resp.ok, body: await resp.json() };
      const text = await resp.text(); return { ok: resp.ok, body: text, warning:'non-json' };
    }).catch(e => ({ ok:false, error: e.message || String(e) }));
  }

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    // ensure DATA.state matches input
    DATA.state = document.getElementById('state').value || DATA.state;
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); } catch(e){console.warn(e);}
    const res = await saveToServer(STORAGE_KEY, DATA);
    const msg = document.getElementById('msg'); msg.style.display='block';
    if(res.ok && res.body && res.body.success){ msg.textContent = 'Saved to server ✅'; msg.className='msg ok'; }
    else { msg.textContent = 'Server save failed: ' + (res.error || JSON.stringify(res.body)); msg.className='msg err'; console.error(res); }
    document.getElementById('savedJson').value = JSON.stringify(DATA,null,2);
  });

  document.getElementById('clearBtn').addEventListener('click', async ()=>{
    if(!confirm('Clear saved Weekly data?')) return;
    try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    DATA = emptyData();
    const res = await saveToServer(STORAGE_KEY, DATA);
    const msg = document.getElementById('msg'); msg.style.display='block';
    if(res.ok && res.body && res.body.success){ msg.textContent='Cleared on server ✅'; msg.className='msg ok'; }
    else { msg.textContent='Cleared locally. Server clear may have failed.'; msg.className='msg err'; }
    renderZoneTable(); updatePreview();
  });

  document.getElementById('backBtn').addEventListener('click', ()=> window.location.href = 'KPI.html');

  document.getElementById('copyJson').addEventListener('click', ()=>{
    const txt = document.getElementById('savedJson').value; if(!txt) return alert('No saved JSON');
    navigator.clipboard?.writeText(txt).then(()=>alert('Copied!'),()=>alert('Copy failed'));
  });

  document.getElementById('importBtn').addEventListener('click', ()=>{
    const raw = document.getElementById('importJson').value.trim(); if(!raw) return alert('Paste JSON to import');
    try {
      const obj = JSON.parse(raw);
      if(!obj.zones) throw new Error('Invalid structure: missing zones');
      DATA = obj;
      // ensure all zones/kpis exist and stateTotals exists
      if(!DATA.stateTotals) DATA.stateTotals = {};
      ZONES.forEach(z => { if(!DATA.zones[z]) DATA.zones[z] = {}; KPI_KEYS.forEach(k=>{ if(DATA.zones[z][k]===undefined) DATA.zones[z][k]=null; }); });
      KPI_KEYS.forEach(k => { if(DATA.stateTotals[k]===undefined) DATA.stateTotals[k]=null; });
      document.getElementById('state').value = DATA.state || document.getElementById('state').value;
      document.getElementById('savedJson').value = JSON.stringify(DATA,null,2);
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); } catch(e){}
      saveToServer(STORAGE_KEY, DATA).then(r=>{ if(!r.ok) console.warn('Server import failed', r); });
      document.getElementById('msg').textContent = 'Imported successfully'; document.getElementById('msg').className='msg ok'; document.getElementById('msg').style.display='block';
      renderZoneTable(); updatePreview();
    } catch(e){ alert('Invalid JSON: '+e.message); }
  });

  document.getElementById('reloadPreview').addEventListener('click', ()=>{
    const cur = (function(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e){return null;} })();
    if(cur){ DATA = cur; document.getElementById('state').value = DATA.state || document.getElementById('state').value; renderZoneTable(); updatePreview(); }
    else alert('No saved local data to reload');
  });

  // when state name changes, update the top label and small labels under zones
  document.getElementById('state').addEventListener('input', ()=>{
    // keep DATA.state in sync but don't rename DATA.zones keys
    DATA.state = document.getElementById('state').value;
    renderZoneTable();
  });

  // init
  (function init(){
    const cur = (function(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e){return null;} })();
    DATA = cur || emptyData();
    // ensure structure is complete
    if(!DATA.stateTotals) DATA.stateTotals = {};
    ZONES.forEach(z => { if(!DATA.zones[z]) DATA.zones[z] = {}; KPI_KEYS.forEach(k=>{ if(DATA.zones[z][k]===undefined) DATA.zones[z][k]=null; }); });
    KPI_KEYS.forEach(k => { if(DATA.stateTotals[k]===undefined) DATA.stateTotals[k]=null; });
    // sync state input with DATA
    document.getElementById('state').value = DATA.state || document.getElementById('state').value;
    renderZoneTable(); updatePreview();
  })();
</script>
</body>
</html>
